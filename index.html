<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control Sólidos Solubles - Atago NFC</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; background: #f4f7f6; }
    .container { max-width: 1100px; margin: 0 auto; }
    .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 16px; }
    h3, h4 { margin-top: 0; color: #1e293b; }
    
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-6 { grid-column: span 6; }
    
    label { font-size: 12px; font-weight: 600; color: #64748b; display: block; margin-bottom: 4px; }
    input, select, button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px; box-sizing: border-box; }
    
    .btn { cursor: pointer; border: 0; font-weight: 600; transition: opacity 0.2s; color: white; }
    .btn-primary { background: #2563eb; }
    .btn-success { background: #16a34a; }
    .btn-secondary { background: #64748b; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .alert { padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none; }
    .alert-err { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .alert-ok { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

    /* Estilos Tabla NFC */
    .nfc-table-container { overflow-x: auto; margin-top: 15px; border: 1px solid #e2e8f0; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th { background: #f8fafc; padding: 12px; text-align: left; font-size: 13px; color: #475569; border-bottom: 2px solid #e2e8f0; }
    td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; }
    
    .val-brix { font-weight: 700; color: #16a34a; font-size: 16px; }
    .val-date { color: #64748b; font-size: 12px; }
    
    .row-sent { background-color: #f0fdf4 !important; opacity: 0.8; }
    .badge-sent { background: #16a34a; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    
    select.small-input { padding: 5px; font-size: 12px; }
    pre { background: #1e293b; color: #f8fafc; padding: 10px; border-radius: 8px; font-size: 11px; overflow: auto; }
  </style>
</head>
<body>

<div class="container">
  <h3 style="text-align:center;">Panel de Medición Atago NFC</h3>

  <div id="err" class="alert alert-err"></div>
  <div id="msg" class="alert alert-ok"></div>

  <!-- I. DATOS CABECERA -->
  <div class="card">
    <h4>I. Datos de Huerto</h4>
    <div class="row">
      <div class="col-3">
        <label>Evaluación *</label>
        <select id="evaluacion">
          <option value="ENS">ENS</option>
          <option value="NV">NV</option>
        </select>
      </div>
      <div class="col-3">
        <label>Tipo *</label>
        <select id="tipoEvaluacion">
          <option value="REC">REC</option>
          <option value="CM">CM</option>
        </select>
      </div>
      <div class="col-3">
        <label>N° Lote *</label>
        <input id="nLote" placeholder="Ej: R1245" />
      </div>
      <div class="col-3">
        <label>Fecha *</label>
        <input id="fecha" type="date" />
      </div>
      <div class="col-6">
        <label>Productor *</label>
        <input id="productor" placeholder="Código productor" />
      </div>
      <div class="col-6">
        <label>Variedad *</label>
        <input id="variedad" placeholder="Variedad" />
      </div>
    </div>
  </div>

  <!-- II. NFC SCANNER -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h4>II. Mediciones del Dispositivo (NFC)</h4>
      <button id="btnScan" class="btn btn-primary" style="width:auto; padding:10px 20px;">Escanear Atago</button>
    </div>

    <div id="nfcPlaceholder" class="muted" style="text-align:center; padding:20px; border:2px dashed #cbd5e1; border-radius:8px;">
      Acerque el dispositivo y presione "Escanear Atago" para ver las 100 mediciones.
    </div>

    <div id="nfcTableContainer" class="nfc-table-container" style="display:none;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Fecha / Hora</th>
            <th>Brix (SST)</th>
            <th>Posición</th>
            <th>Pardeamiento</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="nfcBody"></tbody>
      </table>
    </div>
  </div>

  <!-- DEBUG -->
  <details>
    <summary class="muted" style="cursor:pointer; font-size:12px;">Ver WebSocket & Debug</summary>
    <div class="card" style="margin-top:10px;">
      <div class="row">
        <div class="col-6"><label>WS Estado</label><input id="wsState" readonly /></div>
        <div class="col-6"><label>Último Envío</label><pre id="lastPayload">{}</pre></div>
      </div>
    </div>
  </details>
</div>

<script>
  const WS_URL = "wss://iot.ranco.cl/ws4401/ws/envio-form-solidos-solubles";
  const POS_OPS = ["1","2","3","3.3","3.5","3.8","4","5"];
  const PARDE_OPS = ["", "Leve", "Moderado", "Severo"];
  
  const $ = (id) => document.getElementById(id);
  let ws = null;

  // --- WebSocket ---
  function connectWS() {
    ws = new WebSocket(WS_URL);
    ws.onopen = () => $("wsState").value = "CONECTADO";
    ws.onclose = () => { $("wsState").value = "DESCONECTADO"; setTimeout(connectWS, 3000); };
    ws.onerror = () => $("wsState").value = "ERROR";
    ws.onmessage = (e) => { console.log("Server:", e.data); showMsg("Respuesta recibida del servidor"); };
  }

  function showErr(m) { $("err").textContent = m; $("err").style.display = m ? "block" : "none"; }
  function showMsg(m) { $("msg").textContent = m; $("msg").style.display = m ? "block" : "none"; setTimeout(()=>showMsg(""), 3000); }

  // --- Lógica NFC ---
  async function scanNFC() {
    if (!("NDEFReader" in window)) return showErr("NFC no soportado en este navegador/dispositivo.");
    
    try {
      const reader = new NDEFReader();
      await reader.scan();
      showMsg("Escaneando... acerque el Atago.");

      reader.onreading = (event) => {
        const decoder = new TextDecoder();
        let rawText = "";
        for (const record of event.message.records) {
          rawText += decoder.decode(record.data);
        }
        processNfcData(rawText);
      };
    } catch (e) { showErr("Error al iniciar NFC: " + e); }
  }

  function processNfcData(text) {
    const lines = text.split(/\r?\n/);
    const validReadings = [];
    
    // Regex para capturar: Fecha, Brix, Temp
    // Ejemplo: 2026/01/06 10:54:53,    16.7,    21.8
    const re = /^(\d{4}\/\d{2}\/\d{2}\s+\d{2}:\d{2}:\d{2})\s*,\s*([^,]+)\s*,\s*([\d.]+)/;

    lines.forEach(line => {
      const m = line.match(re);
      if (m) {
        const brixRaw = m[2].trim();
        // FILTRO: Si es LLL o no es un número, se ignora
        const brixNum = parseFloat(brixRaw);
        
        if (!isNaN(brixNum) && brixRaw.toUpperCase() !== "LLL") {
          validReadings.push({
            dt: m[1],
            brix: brixNum.toFixed(1),
            temp: m[3]
          });
        }
      }
    });

    renderNfcTable(validReadings);
  }

  function renderNfcTable(readings) {
    const body = $("nfcBody");
    body.innerHTML = "";
    
    if (readings.length === 0) {
      showErr("No se encontraron mediciones válidas en el tag.");
      return;
    }

    $("nfcPlaceholder").style.display = "none";
    $("nfcTableContainer").style.display = "block";

    readings.forEach((r, i) => {
      const tr = document.createElement("tr");
      tr.id = `row-${i}`;

      tr.innerHTML = `
        <td>${i + 1}</td>
        <td><div class="val-date">${r.dt}</div></td>
        <td><div class="val-brix">${r.brix}</div></td>
        <td>
          <select id="pos-${i}" class="small-input">
            <option value="">-</option>
            ${POS_OPS.map(p => `<option value="${p}">${p}</option>`).join('')}
          </select>
        </td>
        <td>
          <select id="par-${i}" class="small-input">
            ${PARDE_OPS.map(p => `<option value="${p}">${p || 'Ninguno'}</option>`).join('')}
          </select>
        </td>
        <td>
          <button class="btn btn-success" onclick="sendSingleRow(${i}, '${r.dt}', ${r.brix}, ${r.temp})">Enviar</button>
        </td>
      `;
      body.appendChild(tr);
    });
  }

  // --- Envío de Datos ---
  function sendSingleRow(index, dt, brix, temp) {
    const pos = $(`pos-${index}`).value;
    const parde = $(`par-${index}`).value;

    if (!pos) return alert("Seleccione una posición antes de enviar.");
    
    // Validar cabecera
    if (!$("productor").value || !$("nLote").value) {
      return showErr("Complete los datos del huerto (Productor y Lote) antes de enviar.");
    }

    const payload = {
      evaluacion: $("evaluacion").value,
      tipoEvaluacion: $("tipoEvaluacion").value,
      productor: $("productor").value,
      variedad: $("variedad").value,
      nLote: $("nLote").value,
      fecha: $("fecha").value,
      timestamp: new Date().toISOString(),
      tipoFormulario: "solido_soluble",
      // Datos de la medición
      medicion: {
        nFruto: index + 1,
        brix: brix,
        posicion: pos,
        pardeamiento: parde,
        atago_dt: dt,
        atago_temp: temp
      }
    };

    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify(payload));
      $("lastPayload").textContent = JSON.stringify(payload, null, 2);
      
      // Marcar fila como enviada
      const row = $(`row-${index}`);
      row.classList.add("row-sent");
      row.querySelector("td:last-child").innerHTML = `<span class="badge-sent">Enviado</span>`;
      showMsg(`Medición #${index+1} enviada con éxito.`);
    } else {
      showErr("Error: WebSocket no conectado.");
    }
  }

  // Inicializar
  $("fecha").valueAsDate = new Date();
  connectWS();
  $("btnScan").onclick = scanNFC;

</script>

</body>
</html>